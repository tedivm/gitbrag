from datetime import datetime, timedelta

import pytest
from github import GithubException

from gitbrag.conf.settings import Settings
from gitbrag.services.formatter import format_pr_list
from gitbrag.services.github.auth import GitHubClient
from gitbrag.services.github.pullrequests import PullRequestCollector

# Mark all tests in this module as integration tests
pytestmark = pytest.mark.skipif(
    Settings().github_token is None,
    reason="GITHUB_TOKEN not set - skipping integration tests",
)


@pytest.mark.asyncio
async def test_github_authentication_with_real_token() -> None:
    """Test authentication with real GitHub token."""
    settings = Settings()
    assert settings.github_token is not None, "GITHUB_TOKEN must be set"
    token = settings.github_token.get_secret_value()

    client_factory = GitHubClient(token_override=token)
    github_client = await client_factory.get_authenticated_client()

    assert github_client is not None

    # Verify we can get the authenticated user
    async with github_client:
        user = await github_client.get_authenticated_user()
        assert user is not None
        assert user.get("login")


@pytest.mark.asyncio
async def test_collect_user_prs_real_api() -> None:
    """Test collecting PRs for a real user (tedivm)."""
    settings = Settings()
    assert settings.github_token is not None, "GITHUB_TOKEN must be set"
    token = settings.github_token.get_secret_value()

    client = GitHubClient(token_override=token)
    github = await client.get_authenticated_client()

    collector = PullRequestCollector(github)

    # Use a broad time range to ensure we get results
    since = datetime.now() - timedelta(days=365 * 2)  # 2 years ago
    until = datetime.now()

    try:
        prs = await collector.collect_user_prs(
            username="tedivm",
            since=since,
            until=until,
            include_private=False,
        )
    except GithubException as e:
        # Skip test if we hit org restrictions
        if e.status == 403 and "organization forbids" in str(e.data):
            pytest.skip("Token has organization restrictions, skipping test")
        raise

    # tedivm should have at least a few PRs over a 2-year period
    assert len(prs) > 0, "Expected at least some PRs for user tedivm"

    # Verify structure of returned PRs
    for pr in prs[:5]:  # Check first 5 PRs
        assert pr.number > 0
        assert pr.title
        assert pr.repository
        assert pr.url.startswith("https://github.com/")
        assert pr.state in ["open", "closed"]
        assert pr.author == "tedivm"
        assert pr.organization
        assert isinstance(pr.created_at, datetime)


@pytest.mark.asyncio
async def test_collect_user_prs_with_date_filter_real_api() -> None:
    """Test collecting PRs with date filtering using real API."""
    settings = Settings()
    assert settings.github_token is not None, "GITHUB_TOKEN must be set"
    token = settings.github_token.get_secret_value()

    client = GitHubClient(token_override=token)
    github = await client.get_authenticated_client()

    collector = PullRequestCollector(github)

    # Test with 1 year range
    since = datetime.now() - timedelta(days=365)
    until = datetime.now()

    try:
        prs = await collector.collect_user_prs(
            username="tedivm",
            since=since,
            until=until,
            include_private=False,
        )
    except GithubException as e:
        # Skip test if we hit org restrictions
        if e.status == 403 and "organization forbids" in str(e.data):
            pytest.skip("Token has organization restrictions, skipping test")
        raise

    # All PRs should be within date range
    for pr in prs:
        assert pr.created_at >= since, f"PR {pr.number} created before 'since' date"
        assert pr.created_at <= until, f"PR {pr.number} created after 'until' date"


@pytest.mark.asyncio
async def test_collect_user_prs_public_only_real_api() -> None:
    """Test that only public PRs are collected by default."""
    settings = Settings()
    assert settings.github_token is not None, "GITHUB_TOKEN must be set"
    token = settings.github_token.get_secret_value()

    client = GitHubClient(token_override=token)
    github = await client.get_authenticated_client()

    collector = PullRequestCollector(github)

    since = datetime.now() - timedelta(days=365)

    try:
        prs = await collector.collect_user_prs(
            username="tedivm",
            since=since,
            include_private=False,
        )
    except GithubException as e:
        # Skip test if we hit org restrictions
        if e.status == 403 and "organization forbids" in str(e.data):
            pytest.skip("Token has organization restrictions, skipping test")
        raise

    # This test passes if no errors occur
    # We can't easily verify repositories are public without additional API calls
    assert isinstance(prs, list)


@pytest.mark.asyncio
async def test_nonexistent_user_real_api() -> None:
    """Test handling of non-existent user with real API."""
    settings = Settings()
    assert settings.github_token is not None, "GITHUB_TOKEN must be set"
    token = settings.github_token.get_secret_value()

    client = GitHubClient(token_override=token)
    github = await client.get_authenticated_client()

    collector = PullRequestCollector(github)

    # Use a username that is very unlikely to exist
    nonexistent_user = "thisuserdoesnotexist123456789xyz"

    with pytest.raises(ValueError, match="not found"):
        await collector.collect_user_prs(
            username=nonexistent_user,
            since=datetime.now() - timedelta(days=30),
        )


@pytest.mark.asyncio
async def test_format_real_prs() -> None:
    """Test formatting real PRs."""
    settings = Settings()
    assert settings.github_token is not None, "GITHUB_TOKEN must be set"
    token = settings.github_token.get_secret_value()

    client = GitHubClient(token_override=token)
    github = await client.get_authenticated_client()

    collector = PullRequestCollector(github)

    since = datetime.now() - timedelta(days=365)

    try:
        prs = await collector.collect_user_prs(
            username="tedivm",
            since=since,
            include_private=False,
        )
    except GithubException as e:
        # Skip test if we hit org restrictions
        if e.status == 403 and "organization forbids" in str(e.data):
            pytest.skip("Token has organization restrictions, skipping test")
        raise

    # Test that formatting doesn't crash with real data
    if prs:
        # Just verify it doesn't throw an exception
        try:
            format_pr_list(prs[:10], show_urls=False)
            format_pr_list(prs[:10], show_urls=True)
            format_pr_list(prs[:10], sort_fields=[("created_at", "desc")])
            format_pr_list(prs[:10], sort_fields=[("repository", "asc"), ("created_at", "desc")])
        except Exception as e:
            pytest.fail(f"Formatting failed with real data: {e}")


@pytest.mark.asyncio
async def test_basic_api_access() -> None:
    """Test basic API access and rate limiting with real API."""
    settings = Settings()
    assert settings.github_token is not None, "GITHUB_TOKEN must be set"
